# Bumpy Booby API

API can be tested with Mac App Paw and *api.paw* file.

## Enable the API

To enable the Bumpy Booby API log in and go to *Settings -> API* and choose *Enabled*.




## Default API

The API has different modes. This is the default mode. To use `travisci` mode for Travis CI webhooks see below. 

### Request

Send a HTTP POST request with content type `application/x-www-form-urlencoded`. To this URL:

```
https://example.com/index.php?project=PROJECTNAME&page=api
```

Replace `PROJECTNAME` with the project you want to use. This is required even if you only have the default project.

### Authentication

Open/Create `database/api_config.php` file (see `api_config.example.php` for an example) and add the following to the `$API_ACCESS` array:

```
    "API_USERNAME_1" => array(
    	"mode" => "default", // XMODE default
    	"key" => "cfcd208495d565ef66e7dff9f98764da", // md5 hash
    	"projects" => "ALL_PROJECTS", // comma seperated list of projects or "ALL_PROJECTS"
    	"permissions" => "ALL_PERMISSIONS", // comma seperated list of permissions or "ALL_PERMISSIONS"
    ),

```

Replace the **key** with an md5 hash of your API key. You can generate one by opening `/classes/api/keygen.php` in your browser.

You can specify the **projects** that can be used by this user. Just make a comma seperated list (without spaces) like: `default,project-1,other-project`. Or use "ALL_PROJECTS".

You can specify the **permissions** of this user with a comma seperated list (without spaces) like: `new_issue,update_issue`. OR use `ALL_PERMISSIONS` Currently the API only supports `new_issue`!

Pass `api_username` with the username you created in the config file and `api_password` parameter with the user's key (not the hash which is stored in config file) as HTTP POST data.


### POST parameters

The following parameters can be passed to the API with the HTTP POST request:

 * `api_username` (required)
 * `api_password` (required)
 * `action` (required): Set this to `new_issue` to create a new issue. Other values are not supported yet.
 * `issue_summary` (required): Set the title/summary of the issue.
 * `issue_text` (required): Issue content.
 * `issue_status`: Status of the issue. Default is the `default` status.
 * `issue_assignedto`
 * `issue_dependencies`: List of related issues. Format example `#1, #3, #8`.
 * `issue_labels`: List of labels. Format example `urgent, private`.

### Response

The API returns a JSON formatted response.

 * `status`: Value is 1 for success and 0 if an error occurred.
 * `statusDetails`: A description of the error or a success message.
 * `ID`: The ID of the newly created issue. This is only returned if the request was successful.

Example of an successful request response:

```
{
  "status":1,
  "statusDetails":"Bumpy Booby returned: 1",
  "ID":25
}
```




## Travis CI API

The API has different modes: `travisci` is to use Travis CI webhooks (docs: <https://docs.travis-ci.com/user/notifications/#Webhook-notification>). 
You can choose this mode by setting the the GET parameter `XMODE` of your request to `travisci`. This parameter is not required if you use the default mode (see above).

### Request

Add the URL to your `.travis.yml` file for a webhook:

```
notifications:
  webhooks:
    urls:
      - https://example.com/index.php?project=PROJECTNAME&page=api&XMODE=travisci
    on_success: [always|never|change] # default: always
    on_failure: [always|never|change] # default: always
    on_start: [always|never|change] # default: never
```

Webhooks are delivered with a `application/x-www-form-urlencoded` content type using HTTP POST, with the body including a `payload` parameter that contains the JSON webhook payload in a URL-encoded format.
Example payload: <https://gist.github.com/roidrage/9272064#file-gistfile1-json>

See also <https://docs.travis-ci.com/user/notifications/#Webhook-notification>

### Authentication

When Travis CI makes the POST request, a header named `Authorization` is included. Its value is the SHA2 hash of the GitHub username (see below), the name of the repository, and your Travis CI token.

```
sha256('USERNAME/REPOSITORYTRAVIS_TOKEN')
```

Open `database/api_config.php` and add the following to the `$API_ACCESS` array:

```
    "travis-REPOSITORY" => array(
    	"mode" => "travisci", // XMODE travisci
    	"key" => "ca978112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb", // generate key with /classes/api/keygen-travisci.php
    	"projects" => "ALL_PROJECTS", // comma seperated list of projects or "ALL_PROJECTS"
    	"permissions" => "ALL_PERMISSIONS", // comma seperated list of permissions or "ALL_PERMISSIONS"
    ),

```

The **username** has to be `travis-REPOSITORY` where you replace REPOSITORY with the name of your GitHub repository.

Replace the **key** with the Authorization header sent by Travis CI which can be generated by opening `/classes/api/keygen-travisci.php` in your browser.

For the **projects** and **permissions** settings see default API (above).

### Response

Same response as for default API (see above).




## RSS API

The API can import RSS feeds from GitHub and from other Bumpy-Booby instances.

### Configuration

Open/Create `database/api_config.php` file (see `api_config.example.php` for an example) and add the following to the `$RSS` array:

#### GitHub RSS

```
    array(
    	"name" => "github-SOME_NAME",
    	"title_prefix" => "Will be added to issue title",
    	"url" => "https://github.com/USERNAME/REPOSITORY/releases.atom",
    	"project" => "default",
    ),

```

You can find the feed URL to your subscribed repositories on your GitHub dashboard where it says *Subscribe to your news feed*.
For new releases the URL is `https://github.com/USERNAME/REPOSITORY/releases.atom` for commits it is `https://github.com/USERNAME/REPOSITORY/commits/master.atom`.

`name` has to begin with `github-`.

#### Bumpy-Booby RSS

```
    array(
    	"name" => "bumpybooby-SOME_NAME",
    	"title_prefix" => "Prefix this to issue title",
    	"url" => "http://example.com/default/rss",
    	"project" => "2nd-Project",
    ),

```

`name` has to begin with `bumpybooby-`.

### Start Import

Call this URL in your Browser or with cronjob:

```
https://example.com/index.php?page=api&XMODE=rss
```

